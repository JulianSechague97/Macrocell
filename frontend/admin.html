<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Administrador | Macrocell</title>
  <style>
    :root {
      --color-primario: #3498db;
      --color-secundario: #2ecc71;
      --color-fondo: #ecf0f1;
      --color-texto: #2c3e50;
      --color-alerta: #e74c3c;
      --color-warning: #f39c12;
      --color-morado: #9b59b6;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--color-fondo);
      line-height: 1.6;
    }

    .header {
      background: linear-gradient(135deg, var(--color-primario), #2980b9);
      color: white;
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 1.8em;
    }

    .header .cerrar-sesion {
      background-color: var(--color-alerta);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      text-decoration: none;
      transition: all 0.3s;
    }

    .header .cerrar-sesion:hover {
      background-color: #c0392b;
      transform: translateY(-2px);
    }

    /* TABS */
    .tabs {
      background: white;
      display: flex;
      justify-content: center;
      border-bottom: 3px solid var(--color-primario);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      flex-wrap: wrap;
    }

    .tab-button {
      background: transparent;
      border: none;
      padding: 15px 25px;
      font-size: 0.95em;
      cursor: pointer;
      transition: all 0.3s;
      color: var(--color-texto);
      font-weight: 500;
    }

    .tab-button:hover {
      background-color: rgba(52, 152, 219, 0.1);
    }

    .tab-button.active {
      background-color: var(--color-primario);
      color: white;
    }

    /* CONTENIDO */
    .container {
      max-width: 1200px;
      margin: 30px auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h3 {
      color: var(--color-primario);
      margin-bottom: 25px;
      font-size: 1.8em;
      border-bottom: 3px solid var(--color-primario);
      padding-bottom: 10px;
    }

    /* FORMULARIOS */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
      padding: 20px;
      background: #f9fbfd;
      border-radius: 8px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--color-texto);
    }

    input, select, textarea {
      padding: 12px;
      border: 1px solid #dcdfe6;
      border-radius: 6px;
      font-size: 1em;
      transition: all 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--color-primario);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
      outline: none;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    button {
      padding: 12px 25px;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    .btn-primary {
      background-color: var(--color-secundario);
      color: white;
    }

    .btn-primary:hover {
      background-color: #27ae60;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
    }

    .btn-edit {
      background-color: var(--color-warning);
      color: white;
      padding: 8px 12px;
      font-size: 0.9em;
    }

    .btn-edit:hover {
      background-color: #e67e22;
    }

    .btn-delete {
      background-color: var(--color-alerta);
      color: white;
      padding: 8px 12px;
      font-size: 0.9em;
    }

    .btn-delete:hover {
      background-color: #c0392b;
    }

    /* BADGE DE ROL */
    .badge-rol {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85em;
      font-weight: 600;
      display: inline-block;
    }

    .badge-admin {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
    }

    .badge-empleado {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
    }

    /* TABLAS */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 20px;
      border-radius: 8px;
      overflow: hidden;
    }

    th, td {
      text-align: center;
      padding: 15px;
      border-bottom: 1px solid #f4f6f8;
    }

    th {
      background-color: var(--color-primario);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.9em;
    }

    tbody tr:nth-child(even) {
      background-color: #f9fbfd;
    }

    tbody tr:hover {
      background-color: #f0f8ff;
    }

    .acciones {
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #95a5a6;
      font-size: 1.2em;
    }

    /* REPORTES */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--color-primario), #2980b9);
      color: white;
      padding: 25px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .stat-card h4 {
      font-size: 0.9em;
      margin-bottom: 10px;
      opacity: 0.9;
    }

    .stat-card .stat-value {
      font-size: 2em;
      font-weight: bold;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .alert-success {
      background-color: #d4edda;
      color: #155724;
      border-left: 4px solid #28a745;
    }

    .alert-error {
      background-color: #f8d7da;
      color: #721c24;
      border-left: 4px solid #dc3545;
    }

    .hide {
      display: none;
    }

    /* INFO CARD */
    .info-card {
      background: linear-gradient(135deg, var(--color-morado), #8e44ad);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .info-card h4 {
      margin-bottom: 10px;
      font-size: 1.2em;
    }

    .info-card ul {
      margin-left: 20px;
      line-height: 1.8;
    }

    @media (max-width: 768px) {
      .tabs {
        overflow-x: auto;
      }
      
      .tab-button {
        padding: 12px 20px;
        font-size: 0.9em;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üëë Panel del Administrador - Macrocell</h1>
    <a href="login.html" class="cerrar-sesion">‚Üê Cerrar Sesi√≥n</a>
  </div>

 <div class="tabs">
  <button class="tab-button active" onclick="cambiarTab('productos', this)">üì¶ Productos</button>
  <button class="tab-button" onclick="cambiarTab('proveedores', this)">üè≠ Proveedores</button>
  <button class="tab-button" onclick="cambiarTab('clientes', this)">üë• Clientes</button>
  <button class="tab-button" onclick="cambiarTab('ventas', this)">üí∞ Ventas</button>
  <button class="tab-button" onclick="cambiarTab('servicios', this)">üîß Servicio T√©cnico</button>
  <button class="tab-button" onclick="cambiarTab('empleados', this)">üëî Empleados</button>
  <button class="tab-button" onclick="cambiarTab('reportes', this)">üìä Reportes</button>
</div>


  <div class="container">
    <!-- PRODUCTOS TAB -->
    <div id="productos-tab" class="tab-content active">
      <h3>Gesti√≥n de Productos</h3>
      
      <form id="formProducto" class="form-grid">
        <input type="hidden" id="prod_id">
        <div class="form-group">
          <label>Nombre del Producto *</label>
          <input type="text" id="prod_nombre" required>
        </div>
        <div class="form-group">
          <label>Precio de Venta *</label>
          <input type="number" id="prod_precio" step="0.01" required>
        </div>
        <div class="form-group">
          <label>Proveedor *</label>
          <select id="prod_proveedor" required></select>
        </div>
        <div class="form-group">
          <label>Stock *</label>
          <input type="number" id="prod_stock" required>
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <button type="submit" class="btn-primary">üíæ Guardar Producto</button>
        </div>
      </form>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Precio</th>
            <th>Proveedor</th>
            <th>Stock</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaProductos"></tbody>
      </table>
    </div>

    <!-- PROVEEDORES TAB -->
    <div id="proveedores-tab" class="tab-content">
      <h3>Gesti√≥n de Proveedores</h3>
      
      <form id="formProveedor" class="form-grid">
        <input type="hidden" id="prov_id">
        <div class="form-group">
          <label>NIT *</label>
          <input type="text" id="prov_nit" required>
        </div>
        <div class="form-group">
          <label>Nombre *</label>
          <input type="text" id="prov_nombre" required>
        </div>
        <div class="form-group">
          <label>Correo *</label>
          <input type="email" id="prov_correo" required>
        </div>
        <div class="form-group">
          <label>Tel√©fono *</label>
          <input type="text" id="prov_telefono" required>
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label>Direcci√≥n</label>
          <input type="text" id="prov_direccion">
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <button type="submit" class="btn-primary">üíæ Guardar Proveedor</button>
        </div>
      </form>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>NIT</th>
            <th>Nombre</th>
            <th>Correo</th>
            <th>Tel√©fono</th>
            <th>Direcci√≥n</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaProveedores"></tbody>
      </table>
    </div>

    <!-- CLIENTES TAB -->
    <div id="clientes-tab" class="tab-content">
      <h3>Gesti√≥n de Clientes</h3>
      
      <form id="formCliente" class="form-grid">
        <input type="hidden" id="cli_id">
        <div class="form-group">
          <label>C√©dula</label>
          <input type="text" id="cli_cedula">
        </div>
        <div class="form-group">
          <label>Nombre *</label>
          <input type="text" id="cli_nombre" required>
        </div>
        <div class="form-group">
          <label>Correo</label>
          <input type="email" id="cli_correo">
        </div>
        <div class="form-group">
          <label>Tel√©fono *</label>
          <input type="text" id="cli_telefono" required>
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label>Direcci√≥n</label>
          <input type="text" id="cli_direccion">
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <button type="submit" class="btn-primary">üíæ Guardar Cliente</button>
        </div>
      </form>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>C√©dula</th>
            <th>Nombre</th>
            <th>Correo</th>
            <th>Tel√©fono</th>
            <th>Direcci√≥n</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaClientes"></tbody>
      </table>
    </div>

    <!-- VENTAS TAB -->
    <div id="ventas-tab" class="tab-content">
      <h3>Gesti√≥n de Ventas</h3>
      
      <form id="formVenta" class="form-grid">
        <div class="form-group">
          <label>Empleado *</label>
          <select id="venta_empleado" required></select>
        </div>
        <div class="form-group">
          <label>Cliente *</label>
          <select id="venta_cliente" required></select>
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label>Productos</label>
          <div id="productos-venta"></div>
          <button type="button" onclick="agregarProductoVenta()" class="btn-primary" style="margin-top: 10px;">+ Agregar Producto</button>
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <button type="submit" class="btn-primary">üíæ Registrar Venta</button>
        </div>
      </form>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Cliente</th>
            <th>Empleado</th>
            <th>Total</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaVentas"></tbody>
      </table>
    </div>

    <!-- SERVICIO T√âCNICO TAB -->
    <div id="servicios-tab" class="tab-content">
      <h3>Gesti√≥n de Servicio T√©cnico</h3>
      
      <form id="formServicio" class="form-grid">
        <input type="hidden" id="serv_id">
        <div class="form-group">
          <label>Empleado *</label>
          <select id="serv_empleado" required></select>
        </div>
        <div class="form-group">
          <label>Cliente *</label>
          <select id="serv_cliente" required></select>
        </div>
        <div class="form-group">
          <label>Fecha de Entrega *</label>
          <input type="date" id="serv_fecha_entrega" required>
        </div>
        <div class="form-group">
          <label>Estado *</label>
          <select id="serv_estado" required>
            <option value="Pendiente">Pendiente</option>
            <option value="En reparaci√≥n">En reparaci√≥n</option>
            <option value="Entregado">Entregado</option>
          </select>
        </div>
        <div class="form-group">
          <label>Costo *</label>
          <input type="number" id="serv_costo" step="0.01" required>
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label>Descripci√≥n de la Falla *</label>
          <textarea id="serv_descripcion" required></textarea>
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <button type="submit" class="btn-primary">üíæ Guardar Servicio</button>
        </div>
      </form>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Cliente</th>
            <th>Falla</th>
            <th>Ingreso</th>
            <th>Entrega</th>
            <th>Estado</th>
            <th>Costo</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaServicios"></tbody>
      </table>
    </div>

    <!-- EMPLEADOS TAB (NUEVO) -->
    <div id="empleados-tab" class="tab-content">
      <h3>üëî Gesti√≥n de Empleados</h3>

      <div class="info-card">
        <h4>üîê Sistema de Roles</h4>
        <ul>
          <li><strong>Admin:</strong> Acceso total al sistema</li>
          <li><strong>Empleado:</strong> Solo puede gestionar servicios t√©cnicos</li>
        </ul>
        <p style="margin-top: 10px; font-size: 0.9em;">Los triggers de la base de datos garantizan que los empleados no puedan modificar productos, proveedores ni ventas.</p>
      </div>
      
      <form id="formEmpleado" class="form-grid">
        <input type="hidden" id="emp_id">
        <div class="form-group">
          <label>C√©dula *</label>
          <input type="text" id="emp_cedula" required>
        </div>
        <div class="form-group">
          <label>Nombre Completo *</label>
          <input type="text" id="emp_nombre" required>
        </div>
        <div class="form-group">
          <label>Correo *</label>
          <input type="email" id="emp_correo" required>
        </div>
        <div class="form-group">
          <label>Tel√©fono *</label>
          <input type="text" id="emp_telefono" required>
        </div>
        <div class="form-group">
          <label>Contrase√±a *</label>
          <input type="password" id="emp_password" placeholder="M√≠nimo 6 caracteres">
          <small style="color: #666; font-size: 0.85em;">Dejar vac√≠o para mantener la actual (solo en edici√≥n)</small>
        </div>
        <div class="form-group">
          <label>Rol *</label>
          <select id="emp_rol" required>
            <option value="empleado">üë§ Empleado</option>
            <option value="admin">üëë Administrador</option>
          </select>
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <button type="submit" class="btn-primary">üíæ Guardar Empleado</button>
        </div>
      </form>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>C√©dula</th>
            <th>Nombre</th>
            <th>Correo</th>
            <th>Tel√©fono</th>
            <th>Rol</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaEmpleados"></tbody>
      </table>
    </div>

    <!-- REPORTES TAB -->
    <div id="reportes-tab" class="tab-content">
      <h3>üìä Reportes y Estad√≠sticas</h3>
      
      <div class="stats-grid">
        <div class="stat-card">
          <h4>Total Productos</h4>
          <div class="stat-value" id="stat-productos">0</div>
        </div>
        <div class="stat-card">
          <h4>Total Clientes</h4>
          <div class="stat-value" id="stat-clientes">0</div>
        </div>
        <div class="stat-card">
          <h4>Ventas del Mes</h4>
          <div class="stat-value" id="stat-ventas">0</div>
        </div>
        <div class="stat-card">
          <h4>Servicios Activos</h4>
          <div class="stat-value" id="stat-servicios">0</div>
        </div>
      </div>

      <h4 style="margin-top: 30px;">Productos M√°s Vendidos</h4>
      <table>
        <thead>
          <tr>
            <th>Producto</th>
            <th>Cantidad Vendida</th>
            <th>Ingresos Generados</th>
          </tr>
        </thead>
        <tbody id="tablaReporteProductos"></tbody>
      </table>
    </div>
  </div>
  <script src="config.js"></script>
<script>
  const API = API_URL + '/api';
  let productosDisponibles = [];

  // FUNCION DE TABS
  function cambiarTab(tabName, boton) {
    // Ocultar todos los tabs
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    
    // Quitar clase active de todos los botones
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    
    // Mostrar el tab seleccionado
    document.getElementById(`${tabName}-tab`).classList.add('active');
    
    // Marcar el bot√≥n seleccionado como activo
    boton.classList.add('active');

    // Cargar datos espec√≠ficos si aplica
    if (tabName === 'reportes') cargarReportes();
    if (tabName === 'empleados') cargarEmpleadosAdmin();
  }

  // INICIALIZAR DATOS AL CARGAR LA P√ÅGINA
  window.addEventListener("DOMContentLoaded", () => {
    cargarProductos();
    cargarProveedores();
    cargarClientes();
    cargarVentas();
    cargarServicios();
    cargarEmpleadosParaSelects();
    cargarProductosParaVenta();
  });

  // ====================== PRODUCTOS ======================
  async function cargarProductos() {
    try {
  const res = await fetch(`${API}/productos`);
      const data = await res.json();
      productosDisponibles = data;
      const tabla = document.getElementById("tablaProductos");
      tabla.innerHTML = "";

      data.forEach(prod => {
        tabla.innerHTML += `
          <tr>
            <td>${prod.id}</td>
            <td>${prod.nombre}</td>
            <td>$${parseFloat(prod.precio).toLocaleString()}</td>
            <td>${prod.categoria}</td>
            <td>${prod.stock}</td>
            <td class="acciones">
              <button class="btn-edit" onclick="editarProducto(${prod.id}, '${prod.nombre.replace(/'/g, "\\'")}', ${prod.precio}, ${prod.categoria}, ${prod.stock})">‚úèÔ∏è Editar</button>
              <button class="btn-delete" onclick="eliminarProducto(${prod.id})">üóëÔ∏è Eliminar</button>
            </td>
          </tr>`;
      });
    } catch (error) {
      console.error("Error al cargar productos:", error);
    }
  }

  document.getElementById("formProducto").addEventListener("submit", async (e) => {
    e.preventDefault();
    const id = document.getElementById("prod_id").value;
    const producto = {
      nombre: document.getElementById("prod_nombre").value,
      precio: document.getElementById("prod_precio").value,
      categoria: document.getElementById("prod_proveedor").value,
      stock: document.getElementById("prod_stock").value
    };

  const metodo = id ? "PUT" : "POST";
  const url = id ? `${API}/productos/${id}` : `${API}/productos`;

    try {
      await fetch(url, {
        method: metodo,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(producto)
      });
      e.target.reset();
      document.getElementById("prod_id").value = "";
      cargarProductos();
      alert("‚úÖ Producto guardado correctamente");
    } catch (error) {
      alert("‚ùå Error al guardar producto");
    }
  });

  function editarProducto(id, nombre, precio, categoria, stock) {
    document.getElementById("prod_id").value = id;
    document.getElementById("prod_nombre").value = nombre;
    document.getElementById("prod_precio").value = precio;
    document.getElementById("prod_proveedor").value = categoria;
    document.getElementById("prod_stock").value = stock;
    window.scrollTo(0, 0);
  }

  async function eliminarProducto(id) {
    if (confirm("¬øSeguro que deseas eliminar este producto?")) {
        try {
        await fetch(`${API}/productos/${id}`, { method: "DELETE" });
        cargarProductos();
        alert("‚úÖ Producto eliminado");
      } catch (error) {
        alert("‚ùå Error al eliminar producto");
      }
    }
  }

  // ====================== PROVEEDORES ======================
  async function cargarProveedores() {
    try {
  const res = await fetch(`${API}/proveedores`);
      const data = await res.json();
      const tabla = document.getElementById("tablaProveedores");
      const select = document.getElementById("prod_proveedor");

      tabla.innerHTML = "";
      select.innerHTML = '<option value="">Seleccione un proveedor</option>';

      data.forEach(prov => {
        tabla.innerHTML += `
          <tr>
            <td>${prov.ID_proveedor}</td>
            <td>${prov.NIT || ''}</td>
            <td>${prov.Nombre}</td>
            <td>${prov.Correo || ''}</td>
            <td>${prov.Telefono || ''}</td>
            <td>${prov.Direccion || ''}</td>
            <td class="acciones">
              <button class="btn-edit" onclick='editarProveedor(${JSON.stringify(prov)})'>‚úèÔ∏è Editar</button>
              <button class="btn-delete" onclick="eliminarProveedor(${prov.ID_proveedor})">üóëÔ∏è Eliminar</button>
            </td>
          </tr>`;
        select.innerHTML += `<option value="${prov.ID_proveedor}">${prov.Nombre}</option>`;
      });
    } catch (error) {
      console.error("Error al cargar proveedores:", error);
    }
  }

  // ====================== CLIENTES ======================
  async function cargarClientes() {
    try {
      const res = await fetch(`${API}/clientes`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const tabla = document.getElementById("tablaClientes");
      tabla.innerHTML = "";

      if (!data || data.length === 0) {
        tabla.innerHTML = '<tr><td colspan="7" class="empty-state">Sin clientes registrados</td></tr>';
        return;
      }

      // tambi√©n actualizar el select de clientes para ventas
      const selectVentaCliente = document.getElementById('venta_cliente');
      if (selectVentaCliente) selectVentaCliente.innerHTML = '';

      data.forEach(cli => {
        tabla.innerHTML += `
          <tr>
            <td>${cli.ID_cliente}</td>
            <td>${cli.Cedula || ''}</td>
            <td>${cli.Nombre || ''}</td>
            <td>${cli.Correo || ''}</td>
            <td>${cli.Telefono || ''}</td>
            <td>${cli.Direccion || ''}</td>
            <td class="acciones">
              <button class="btn-edit btn-edit-client" data-id="${cli.ID_cliente}">‚úèÔ∏è Editar</button>
              <button class="btn-delete btn-delete-client" data-id="${cli.ID_cliente}">üóëÔ∏è Eliminar</button>
            </td>
          </tr>`;
        if (selectVentaCliente) {
          const opt = document.createElement('option');
          opt.value = cli.ID_cliente;
          opt.textContent = cli.Nombre || (`ID ${cli.ID_cliente}`);
          selectVentaCliente.appendChild(opt);
        }
      });

      // attach event listeners to the newly created buttons (safer than inline onclick)
      document.querySelectorAll('.btn-edit-client').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.currentTarget.dataset.id;
          if (id) editarCliente(id);
        });
      });
      document.querySelectorAll('.btn-delete-client').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.currentTarget.dataset.id;
          if (id) eliminarCliente(id);
        });
      });
    } catch (error) {
      console.error("Error al cargar clientes:", error);
    }
  }

  // manejar formulario de clientes (crear / actualizar)
  const formCliente = document.getElementById('formCliente');
  if (formCliente) {
    formCliente.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('cli_id').value;
      const Cedula = document.getElementById('cli_cedula').value || null;
      const Nombre = document.getElementById('cli_nombre').value || '';
      const Correo = document.getElementById('cli_correo').value || null;
      const Telefono = document.getElementById('cli_telefono').value || null;
      const Direccion = document.getElementById('cli_direccion').value || null;

      try {
        if (!Nombre || !Telefono) {
          alert('Por favor ingresa los campos requeridos (Nombre y Tel√©fono).');
          return;
        }

        if (id) {
          // actualizar
          const res = await fetch(`${API}/clientes/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ Cedula, Nombre, Correo, Telefono, Direccion })
          });
          if (!res.ok) {
            const err = await res.json().catch(()=> ({}));
            throw new Error(err.error || err.message || `HTTP ${res.status}`);
          }
          alert('Cliente actualizado correctamente');
        } else {
          // crear
          const res = await fetch(`${API}/clientes`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ Cedula, Nombre, Correo, Telefono, Direccion })
          });
          if (!res.ok) {
            const err = await res.json().catch(()=> ({}));
            throw new Error(err.error || err.message || `HTTP ${res.status}`);
          }
          alert('Cliente creado correctamente');
        }

        // limpiar y recargar
        document.getElementById('cli_id').value = '';
        formCliente.reset();
        cargarClientes();
      } catch (err) {
        alert('Error: ' + (err.message || err));
      }
    });
  }

  // editar cliente: carga datos en el formulario
  async function editarCliente(id) {
    try {
      const res = await fetch(`${API}/clientes/${id}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const cli = await res.json();
      document.getElementById('cli_id').value = cli.ID_cliente;
      document.getElementById('cli_cedula').value = cli.Cedula || '';
      document.getElementById('cli_nombre').value = cli.Nombre || '';
      document.getElementById('cli_correo').value = cli.Correo || '';
      document.getElementById('cli_telefono').value = cli.Telefono || '';
      document.getElementById('cli_direccion').value = cli.Direccion || '';
      // scroll to form
      document.getElementById('clientes-tab').scrollIntoView({ behavior: 'smooth' });
    } catch (err) {
      alert('No se pudo cargar el cliente: ' + (err.message || err));
    }
  }

  // eliminar cliente
  async function eliminarCliente(id) {
    if (!confirm('¬øSeguro que deseas eliminar este cliente?')) return;
    try {
      const res = await fetch(`${API}/clientes/${id}`, { method: 'DELETE' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      alert('Cliente eliminado');
      cargarClientes();
    } catch (err) {
      alert('Error al eliminar cliente: ' + (err.message || err));
    }
  }

  // ====================== VENTAS ======================
  async function cargarVentas() {
    try {
      const res = await fetch(`${API}/ventas`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const tabla = document.getElementById('tablaVentas');
      tabla.innerHTML = '';

      if (data.length === 0) {
        tabla.innerHTML = '<tr><td colspan="6" class="empty-state">Sin ventas registradas</td></tr>';
        return;
      }

      data.forEach(venta => {
        // defensivo: aceptar varios nombres posibles devueltos por el backend
        const nombreCliente = venta.nombre_cliente ?? venta.Nombre ?? venta.nombre ?? venta.Nombre_cliente ?? 'N/A';
        const nombreEmpleado = venta.nombre_empleado ?? venta.Nombre_empleado ?? venta.nombre_empleado ?? venta.Nombre ?? 'N/A';

        tabla.innerHTML += `
          <tr>
            <td>${venta.ID_venta}</td>
            <td>${venta.Fecha_venta ? new Date(venta.Fecha_venta).toLocaleDateString('es-CO') : 'N/A'}</td>
            <td>${nombreCliente}</td>
            <td>${nombreEmpleado}</td>
            <td>$${parseFloat(venta.Total || 0).toLocaleString('es-CO', {minimumFractionDigits: 2})}</td>
            <td class="acciones">
              <button class="btn-delete btn-delete-venta" data-id="${venta.ID_venta}">üóëÔ∏è Eliminar</button>
            </td>
          </tr>`;
      });

      // attach listeners for venta deletes
      document.querySelectorAll('.btn-delete-venta').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.currentTarget.dataset.id;
          if (id) eliminarVenta(id);
        });
      });
    } catch (error) {
      console.error('Error al cargar ventas:', error);
    }
  }

  async function eliminarVenta(id) {
    if (!confirm('¬øSeguro que deseas eliminar esta venta?')) return;
    try {
      const res = await fetch(`${API}/ventas/${id}`, { method: 'DELETE' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      alert('‚úÖ Venta eliminada');
      cargarVentas();
    } catch (error) {
      alert('‚ùå Error al eliminar venta: ' + error.message);
    }
  }

  // ====================== SERVICIOS ======================
  async function cargarServicios() {
    try {
      const res = await fetch(`${API}/servicios`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const tabla = document.getElementById('tablaServicios');
      tabla.innerHTML = '';

      if (data.length === 0) {
        tabla.innerHTML = '<tr><td colspan="8" class="empty-state">Sin servicios registrados</td></tr>';
        return;
      }

      data.forEach(srv => {
        tabla.innerHTML += `
          <tr>
            <td>${srv.ID_servicioTecnico}</td>
            <td>${srv.nombre_cliente || 'N/A'}</td>
            <td>${srv.Descripcion_falla || 'N/A'}</td>
            <td>${new Date(srv.Fecha_ingreso).toLocaleDateString('es-CO')}</td>
            <td>${new Date(srv.Fecha_entrega).toLocaleDateString('es-CO')}</td>
            <td><span class="badge-rol ${srv.Estado === 'Entregado' ? 'badge-empleado' : 'badge-admin'}">${srv.Estado}</span></td>
            <td>$${parseFloat(srv.Costo_reparacion).toLocaleString('es-CO', {minimumFractionDigits: 2})}</td>
            <td class="acciones">
              <button class="btn-edit" onclick='editarServicio(${JSON.stringify(srv)})'>‚úèÔ∏è Editar</button>
              <button class="btn-delete" onclick="eliminarServicio(${srv.ID_servicioTecnico})">üóëÔ∏è Eliminar</button>
            </td>
          </tr>`;
      });
    } catch (error) {
      console.error('Error al cargar servicios:', error);
    }
  }

  function editarServicio(srv) {
    document.getElementById('serv_id').value = srv.ID_servicioTecnico;
    document.getElementById('serv_cliente').value = srv.ID_cliente;
    document.getElementById('serv_empleado').value = srv.ID_usuario;
    document.getElementById('serv_fecha_entrega').value = srv.Fecha_entrega ? srv.Fecha_entrega.split('T')[0] : '';
    document.getElementById('serv_estado').value = srv.Estado;
    document.getElementById('serv_costo').value = srv.Costo_reparacion;
    document.getElementById('serv_descripcion').value = srv.Descripcion_falla;
    window.scrollTo(0, 0);
  }

  async function eliminarServicio(id) {
    if (!confirm('¬øSeguro que deseas eliminar este servicio?')) return;
    try {
      const res = await fetch(`${API}/servicios/${id}`, { method: 'DELETE' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      alert('‚úÖ Servicio eliminado');
      cargarServicios();
    } catch (error) {
      alert('‚ùå Error al eliminar servicio: ' + error.message);
    }
  }

  // ====================== EMPLEADOS ======================
  async function cargarEmpleadosAdmin() {
    try {
      const res = await fetch(`${API}/empleados`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const tabla = document.getElementById('tablaEmpleados');
      tabla.innerHTML = '';

      data.forEach(emp => {
        tabla.innerHTML += `
          <tr>
            <td>${emp.ID_usuario}</td>
            <td>${emp.Cedula || ''}</td>
            <td>${emp.Nombre}</td>
            <td>${emp.Correo}</td>
            <td>${emp.Telefono || ''}</td>
            <td><span class="badge-rol ${emp.rol === 'admin' ? 'badge-admin' : 'badge-empleado'}">${emp.rol}</span></td>
            <td class="acciones">
              <button class="btn-edit" onclick='editarEmpleado(${JSON.stringify(emp)})'>‚úèÔ∏è Editar</button>
              <button class="btn-delete" onclick="eliminarEmpleadoAdmin(${emp.ID_usuario})">üóëÔ∏è Eliminar</button>
            </td>
          </tr>`;
      });
    } catch (error) {
      console.error('Error al cargar empleados:', error);
    }
  }

  // Editar: rellenar formulario con datos del empleado
  function editarEmpleado(emp) {
    document.getElementById('emp_id').value = emp.ID_usuario;
    document.getElementById('emp_cedula').value = emp.Cedula || '';
    document.getElementById('emp_nombre').value = emp.Nombre || '';
    document.getElementById('emp_correo').value = emp.Correo || '';
    document.getElementById('emp_telefono').value = emp.Telefono || '';
    document.getElementById('emp_rol').value = emp.rol || 'empleado';
    window.scrollTo(0, 0);
  }

  // Eliminar empleado desde admin
  async function eliminarEmpleadoAdmin(id) {
    if (!confirm('¬øSeguro que deseas eliminar este empleado?')) return;
    try {
      const res = await fetch(`${API}/empleados/${id}`, { method: 'DELETE' });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || JSON.stringify(data));
      alert('‚úÖ Empleado eliminado');
      cargarEmpleadosAdmin();
    } catch (error) {
      alert('‚ùå Error al eliminar empleado: ' + error.message);
    }
  }

  // Manejo del submit para crear/editar empleados
  document.getElementById('formEmpleado').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('emp_id').value;
    const Cedula = document.getElementById('emp_cedula').value.trim();
    const Nombre = document.getElementById('emp_nombre').value.trim();
    const Correo = document.getElementById('emp_correo').value.trim();
    const Telefono = document.getElementById('emp_telefono').value.trim();
    const Contrasena_acceso = document.getElementById('emp_password').value;
    const rol = document.getElementById('emp_rol').value;

    // Validaciones b√°sicas
    if (!Nombre || !Correo) {
      alert('Nombre y correo son obligatorios');
      return;
    }

    if (!id && (!Contrasena_acceso || Contrasena_acceso.length < 6)) {
      alert('La contrase√±a es obligatoria y debe tener al menos 6 caracteres');
      return;
    }

    const payload = { Cedula: Cedula || null, Nombre, Correo, Telefono: Telefono || null, rol };
    if (Contrasena_acceso) payload.Contrasena_acceso = Contrasena_acceso;

    const metodo = id ? 'PUT' : 'POST';
    const url = id ? `${API}/empleados/${id}` : `${API}/empleados`;

    const btn = e.target.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.textContent = id ? 'Guardando...' : 'Creando...';

    try {
      const res = await fetch(url, {
        method: metodo,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || data.message || JSON.stringify(data));

      alert(id ? '‚úÖ Empleado actualizado' : '‚úÖ Empleado creado');
      e.target.reset();
      document.getElementById('emp_id').value = '';
      cargarEmpleadosAdmin();
    } catch (error) {
      alert('‚ùå Error al guardar empleado: ' + error.message);
    } finally {
      btn.disabled = false;
      btn.textContent = 'üíæ Guardar Empleado';
    }
  });

  function cargarEmpleadosParaSelects() {
    // Cargar empleados para dropdowns en ventas/servicios
    fetch(`${API}/empleados`)
      .then(r => r.json())
      .then(data => {
        const selectVenta = document.getElementById('venta_empleado');
        const selectServicio = document.getElementById('serv_empleado');
        selectVenta.innerHTML = '<option value="">Seleccione un empleado</option>';
        selectServicio.innerHTML = '<option value="">Seleccione un empleado</option>';
        data.forEach(emp => {
          const opt1 = document.createElement('option');
          opt1.value = emp.ID_usuario;
          opt1.textContent = emp.Nombre;
          selectVenta.appendChild(opt1);
          const opt2 = opt1.cloneNode(true);
          selectServicio.appendChild(opt2);
        });
      })
      .catch(e => console.error('Error cargando empleados:', e));
  }

  function cargarProductosParaVenta() {
    // Cargar productos disponibles para ventas
    fetch(`${API}/productos`)
      .then(r => r.json())
      .then(data => {
        const div = document.getElementById('productos-venta');
        div.innerHTML = '';
        data.forEach(prod => {
          const item = document.createElement('div');
          item.style.marginBottom = '10px';

          // Normalizar nombres de campos seg√∫n lo que el backend pueda devolver
          const id = prod.ID_producto ?? prod.id ?? prod.ID ?? prod.Id;
          const nombre = prod.Nombre ?? prod.nombre ?? prod.nombre_producto ?? prod.Nombre_producto ?? prod.nombreProducto ?? 'Producto';
          const precioRaw = prod.Precio_venta ?? prod.precio ?? prod.Precio ?? prod.precio_venta ?? 0;
          const precio = Number(precioRaw) || 0;

          item.innerHTML = `
            <label>
              <input type="checkbox" class="producto-checkbox" data-id="${id}" data-precio="${precio}">
              ${nombre} - $${precio.toLocaleString('es-CO', {minimumFractionDigits: 2})}
            </label>
            <input type="number" min="1" value="1" class="producto-cantidad" data-id="${id}" style="width: 60px;">
          `;
          div.appendChild(item);
        });
      })
      .catch(e => console.error('Error cargando productos:', e));
  }

  // Agrega una fila de selecci√≥n de producto (select + cantidad) al form de ventas
  function agregarProductoVenta() {
    const container = document.getElementById('productos-venta');
    if (!container) return;

    const row = document.createElement('div');
    row.style.marginBottom = '10px';
    row.className = 'producto-select-row';

    const select = document.createElement('select');
    select.className = 'producto-select';
    select.style.marginRight = '8px';

    // option por defecto
    const emptyOpt = document.createElement('option');
    emptyOpt.value = '';
    emptyOpt.textContent = 'Seleccione producto...';
    select.appendChild(emptyOpt);

    // usar productosDisponibles (cargado por cargarProductos)
    (productosDisponibles || []).forEach(p => {
      const id = p.ID_producto ?? p.id ?? p.ID ?? p.Id;
      const nombre = p.Nombre ?? p.nombre ?? p.nombre_producto ?? p.Nombre_producto ?? p.nombreProducto ?? 'Producto';
      const precioRaw = p.Precio_venta ?? p.precio ?? p.Precio ?? p.precio_venta ?? 0;
      const precio = Number(precioRaw) || 0;
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = `${nombre} - $${precio.toLocaleString('es-CO', {minimumFractionDigits:2})}`;
      opt.dataset.precio = precio;
      select.appendChild(opt);
    });

    const qty = document.createElement('input');
    qty.type = 'number'; qty.min = '1'; qty.value = '1';
    qty.className = 'producto-cantidad';
    qty.style.width = '60px'; qty.style.marginRight = '8px';

    const btnRemove = document.createElement('button');
    btnRemove.type = 'button';
    btnRemove.textContent = 'Eliminar';
    btnRemove.className = 'btn-delete';
    btnRemove.addEventListener('click', () => row.remove());

    row.appendChild(select);
    row.appendChild(qty);
    row.appendChild(btnRemove);

    container.appendChild(row);
  }

  // Manejador para formVenta
  document.getElementById('formVenta').addEventListener('submit', async (e) => {
    e.preventDefault();
    const ID_usuario = document.getElementById('venta_empleado').value;
    const ID_cliente = document.getElementById('venta_cliente').value || null;

    // Coleccionar productos desde checkboxes y desde selects a√±adidos manualmente
    const productos = [];

    // desde checkboxes (renderizados por cargarProductosParaVenta)
    const productosChecked = Array.from(document.querySelectorAll('.producto-checkbox:checked'));
    productosChecked.forEach(chk => {
      const id = chk.dataset.id;
      const cantidadInput = document.querySelector(`.producto-cantidad[data-id="${id}"]`);
      const cantidad = cantidadInput ? parseInt(cantidadInput.value) || 1 : 1;
      const precio_venta = parseFloat(chk.dataset.precio) || 0;
      productos.push({ ID_producto: parseInt(id), cantidad, precio_venta });
    });

    // desde filas de select creadas con agregarProductoVenta
    const filasSelect = Array.from(document.querySelectorAll('.producto-select-row'));
    filasSelect.forEach(row => {
      const sel = row.querySelector('.producto-select');
      const qty = row.querySelector('.producto-cantidad');
      if (!sel || !sel.value) return; // no seleccionado
      const id = sel.value;
      const precio_venta = parseFloat(sel.options[sel.selectedIndex]?.dataset?.precio) || 0;
      const cantidad = qty ? parseInt(qty.value) || 1 : 1;
      productos.push({ ID_producto: parseInt(id), cantidad, precio_venta });
    });

    if (productos.length === 0) {
      alert('Selecciona al menos un producto');
      return;
    }

    const payload = { ID_usuario: parseInt(ID_usuario), ID_cliente: ID_cliente ? parseInt(ID_cliente) : null, productos };

    const btn = e.target.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.textContent = 'Registrando...';

    try {
      const res = await fetch(`${API}/ventas`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || JSON.stringify(data));

      alert(`‚úÖ Venta registrada.\nID: ${data.ID_venta}\nTotal: $${data.total}`);
      // limpiar formulario y elementos din√°micos
      e.target.reset();
      // remover filas de selects agregadas manualmente
      document.querySelectorAll('.producto-select-row').forEach(r => r.remove());
      // desmarcar checkboxes de productos y resetear cantidades
      document.querySelectorAll('.producto-checkbox').forEach(chk => {
        chk.checked = false;
        const id = chk.dataset.id;
        const q = document.querySelector(`.producto-cantidad[data-id="${id}"]`);
        if (q) q.value = 1;
      });
      cargarVentas();
    } catch (error) {
      alert('‚ùå Error al registrar venta: ' + error.message);
    } finally {
      btn.disabled = false;
      btn.textContent = 'üíæ Registrar Venta';
    }
  });

  // Manejador para formServicio
  document.getElementById('formServicio').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('serv_id').value;
    const ID_usuario = document.getElementById('serv_empleado').value;
    const ID_cliente = document.getElementById('serv_cliente').value;
    const Fecha_entrega = document.getElementById('serv_fecha_entrega').value;
    const Estado = document.getElementById('serv_estado').value;
    const Costo_reparacion = document.getElementById('serv_costo').value;
    const Descripcion_falla = document.getElementById('serv_descripcion').value;

    if (!ID_usuario || !ID_cliente || !Fecha_entrega || !Costo_reparacion || !Descripcion_falla) {
      alert('Todos los campos son obligatorios');
      return;
    }

    const payload = {
      ID_usuario: parseInt(ID_usuario),
      ID_cliente: parseInt(ID_cliente),
      Fecha_entrega,
      Estado,
      Costo_reparacion: parseFloat(Costo_reparacion),
      Descripcion_falla
    };

    const metodo = id ? 'PUT' : 'POST';
    const url = id ? `${API}/servicios/${id}` : `${API}/servicios`;

    const btn = e.target.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.textContent = 'Guardando...';

    try {
      const res = await fetch(url, {
        method: metodo,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || JSON.stringify(data));

      alert(id ? '‚úÖ Servicio actualizado' : '‚úÖ Servicio creado');
      e.target.reset();
      document.getElementById('serv_id').value = '';
      cargarServicios();
    } catch (error) {
      alert('‚ùå Error al guardar servicio: ' + error.message);
    } finally {
      btn.disabled = false;
      btn.textContent = 'üíæ Guardar Servicio';
    }
  });

  // ====================== REPORTES ======================
  function cargarReportes() {
    // L√≥gica para cargar estad√≠sticas y productos m√°s vendidos
    fetch(`${API_URL}/top5`)
      .then(r => r.json())
      .then(data => {
        const tabla = document.getElementById('tablaReporteProductos');
        tabla.innerHTML = '';
        data.forEach(prod => {
          tabla.innerHTML += `
            <tr>
              <td>${prod.Nombre}</td>
              <td>${prod.total_vendido}</td>
              <td>$${(prod.total_vendido * prod.Precio_venta).toLocaleString('es-CO', {minimumFractionDigits: 2})}</td>
            </tr>`;
        });
      })
      .catch(e => console.error('Error cargando top5:', e));
  }
</script>
